<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Patients - OneScript</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <div id="header"></div>

  <div class="container">
    <a href="admin-dashboard.html" class="back-link">← Back to Dashboard</a>
    
    <h1 class="page-title">Manage Patients</h1>
    <p class="page-subtitle">View and manage patient accounts</p>

    <div class="card" style="margin-bottom: 2rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
          <h2 style="margin-bottom: 0.5rem;">Add New Patient</h2>
          <p style="color: var(--text-light); margin: 0;">Create a new patient account</p>
        </div>
        <button class="btn-primary" onclick="showAddPatientModal()">+ Add Patient</button>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="card" style="margin-bottom: 2rem;">
      <div style="display: flex; gap: 1rem; align-items: center;">
        <div style="flex: 1;">
          <input type="text" class="form-input" id="searchInput" placeholder="Search by name, email, or phone..." onkeyup="filterPatients()">
        </div>
        <select class="form-input" id="statusFilter" style="width: 200px;" onchange="filterPatients()">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="pending">Pending Verification</option>
        </select>
      </div>
    </div>

    <!-- Patients List -->
    <div class="card">
      <h2 style="margin-bottom: 1.5rem;">All Patients</h2>
      <div id="patientsList">
        <!-- Patients will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Add/Edit Patient Modal -->
  <div class="modal-overlay" id="patientModal">
    <div class="modal" style="max-width: 600px;">
      <button class="modal-close" onclick="closeModal('patientModal')">×</button>
      <h2 id="modalTitle" style="margin-bottom: 1.5rem;">Add New Patient</h2>
      
      <form id="patientForm">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" id="patientName" placeholder="Enter full name" required>
        </div>

        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="patientEmail" placeholder="patient@example.com" required>
        </div>

        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="tel" class="form-input" id="patientPhone" placeholder="(123) 456-7890" required>
        </div>

        <div class="form-group">
          <label class="form-label">Date of Birth</label>
          <input type="date" class="form-input" id="patientDOB" required>
        </div>

        <div class="form-group">
          <label class="form-label">Sex</label>
          <select class="form-input" id="patientSex" required>
            <option value="">Select</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Ontario Health Card Number</label>
          <input type="text" class="form-input" id="patientHealthCard" placeholder="12234567890AB" required>
        </div>

        <div class="form-group">
          <label class="form-label">Address</label>
          <input type="text" class="form-input" id="patientAddress" placeholder="Enter address" required>
        </div>

        <div class="form-group">
          <label class="form-label">Weight (kg)</label>
          <input type="number" class="form-input" id="patientWeight" placeholder="Enter weight" step="0.1" min="0">
        </div>

        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-input" id="patientStatus" required>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="pending">Pending Verification</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeModal('patientModal')">Cancel</button>
          <button type="submit" class="btn-primary" id="submitBtn">Add Patient</button>
        </div>
      </form>
    </div>
  </div>

  <div id="footer"></div>

  <script src="../js/app.js"></script>
  <script>
    let patients = JSON.parse(localStorage.getItem('patients') || '[]');
    let editingPatientId = null;
    let allPatients = [];

    // Load and display patients
    function loadPatients() {
      allPatients = [...patients];
      filterPatients();
    }

    // Filter patients
    function filterPatients() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      
      let filtered = allPatients.filter(patient => {
        const matchesSearch = !searchTerm || 
          patient.name.toLowerCase().includes(searchTerm) ||
          patient.email.toLowerCase().includes(searchTerm) ||
          (patient.phone && patient.phone.includes(searchTerm));
        
        const matchesStatus = !statusFilter || patient.status === statusFilter;
        
        return matchesSearch && matchesStatus;
      });

      displayPatients(filtered);
    }

    // Display patients
    function displayPatients(patientsToShow) {
      const patientsList = document.getElementById('patientsList');
      patientsList.innerHTML = '';

      if (patientsToShow.length === 0) {
        patientsList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No patients found.</p>';
        return;
      }

      // Create table
      const table = document.createElement('table');
      table.className = 'table';
      
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Health Card</th>
          <th>Status</th>
          <th>Registered</th>
          <th>Actions</th>
        </tr>
      `;
      
      const tbody = document.createElement('tbody');
      patientsToShow.forEach(patient => {
        const row = document.createElement('tr');
        const statusClass = patient.status === 'active' ? 'badge-approved' : 
                           patient.status === 'pending' ? 'badge-pending' : 'badge-rejected';
        const statusText = patient.status === 'active' ? 'Active' : 
                          patient.status === 'pending' ? 'Pending Verification' : 'Inactive';
        
        const registeredDate = patient.registeredDate ? 
          new Date(patient.registeredDate).toLocaleDateString() : 
          new Date().toLocaleDateString();
        
        row.innerHTML = `
          <td>${patient.name}</td>
          <td>${patient.email}</td>
          <td>${patient.phone || 'N/A'}</td>
          <td>${patient.healthCard || 'N/A'}</td>
          <td><span class="badge ${statusClass}">${statusText}</span></td>
          <td>${registeredDate}</td>
          <td>
            <a href="#" class="link" onclick="editPatient('${patient.id}'); return false;">Edit</a> | 
            <a href="#" class="link" style="color: var(--error);" onclick="deletePatient('${patient.id}'); return false;">Delete</a>
          </td>
        `;
        tbody.appendChild(row);
      });
      
      table.appendChild(thead);
      table.appendChild(tbody);
      patientsList.appendChild(table);
    }

    // Show add patient modal
    function showAddPatientModal() {
      editingPatientId = null;
      document.getElementById('modalTitle').textContent = 'Add New Patient';
      document.getElementById('submitBtn').textContent = 'Add Patient';
      document.getElementById('patientForm').reset();
      document.getElementById('patientStatus').value = 'active';
      showModal('patientModal');
    }

    // Edit patient
    function editPatient(patientId) {
      const patient = patients.find(p => p.id === patientId);
      if (!patient) return;

      editingPatientId = patientId;
      document.getElementById('modalTitle').textContent = 'Edit Patient';
      document.getElementById('submitBtn').textContent = 'Update Patient';
      
      document.getElementById('patientName').value = patient.name || '';
      document.getElementById('patientEmail').value = patient.email || '';
      document.getElementById('patientPhone').value = patient.phone || '';
      document.getElementById('patientDOB').value = patient.dob || '';
      document.getElementById('patientSex').value = patient.sex || '';
      document.getElementById('patientHealthCard').value = patient.healthCard || '';
      document.getElementById('patientAddress').value = patient.address || '';
      document.getElementById('patientWeight').value = patient.weight || '';
      document.getElementById('patientStatus').value = patient.status || 'active';

      showModal('patientModal');
    }

    // Delete patient
    function deletePatient(patientId) {
      if (!confirm('Are you sure you want to delete this patient?')) return;
      
      patients = patients.filter(p => p.id !== patientId);
      savePatients();
      loadPatients();
    }

    // Handle form submission
    document.getElementById('patientForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const patient = {
        id: editingPatientId || 'patient-' + Date.now(),
        name: document.getElementById('patientName').value.trim(),
        email: document.getElementById('patientEmail').value.trim(),
        phone: document.getElementById('patientPhone').value.trim(),
        dob: document.getElementById('patientDOB').value,
        sex: document.getElementById('patientSex').value,
        healthCard: document.getElementById('patientHealthCard').value.trim(),
        address: document.getElementById('patientAddress').value.trim(),
        weight: document.getElementById('patientWeight').value ? parseFloat(document.getElementById('patientWeight').value) : null,
        status: document.getElementById('patientStatus').value,
        registeredDate: editingPatientId ? 
          (patients.find(p => p.id === editingPatientId)?.registeredDate || new Date().toISOString()) : 
          new Date().toISOString()
      };

      if (editingPatientId) {
        const index = patients.findIndex(p => p.id === editingPatientId);
        if (index !== -1) patients[index] = patient;
      } else {
        patients.push(patient);
      }

      savePatients();
      loadPatients();
      closeModal('patientModal');
    });

    // Save patients
    function savePatients() {
      localStorage.setItem('patients', JSON.stringify(patients));
    }

    // Initialize
    loadPatients();
    setupModalClose('patientModal');
  </script>
</body>
</html>

