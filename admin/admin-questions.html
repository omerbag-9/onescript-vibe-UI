<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Assessment Questions - OneScript</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <div id="header"></div>

  <div class="container">
    <a href="admin-dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
    
    <h1 class="page-title">Manage Assessment Questions</h1>
    <p class="page-subtitle">Add new diseases and manage assessment questions for each condition</p>

    <!-- Add New Disease Card -->
    <div class="card" style="margin-bottom: 2rem;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 style="margin-bottom: 0.5rem;">Add New Disease/Condition</h2>
          <p style="color: var(--text-light); margin: 0;">Create assessment questions for new healthcare conditions</p>
        </div>
        <button class="btn-primary" onclick="showAddDiseaseModal()">+ Add New Disease</button>
      </div>
    </div>

    <!-- Diseases List -->
    <div class="card" style="margin-bottom: 2rem;">
      <h2 style="margin-bottom: 1.5rem;">Select Disease to Manage Questions</h2>
      <div id="diseasesList" class="service-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
        <!-- Diseases will be loaded here -->
      </div>
    </div>

    <!-- Questions for Selected Disease -->
    <div class="card" id="questionsSection" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
          <h2 id="selectedDiseaseTitle">Disease Questions</h2>
          <p style="color: var(--text-light); margin-top: 0.5rem;">Manage questions for: <strong id="selectedDiseaseName"></strong></p>
        </div>
        <button class="btn-primary" onclick="showAddQuestionModal()">+ Add Question</button>
      </div>

      <div id="questionsList">
        <!-- Questions will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Add Disease Modal -->
  <div class="modal-overlay" id="addDiseaseModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('addDiseaseModal')" type="button">√ó</button>
      <h2 style="margin-bottom: 1.5rem;">Add New Disease/Condition</h2>
      
      <form id="addDiseaseForm">
        <div class="form-group">
          <label class="form-label">Disease/Condition Name</label>
          <input type="text" class="form-input" id="diseaseName" placeholder="e.g., Hair Loss, Weight Loss, Acne" required>
        </div>

        <div class="form-group">
          <label class="form-label">Description (Optional)</label>
          <textarea class="form-input" id="diseaseDescription" rows="3" placeholder="Brief description of the condition"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeModal('addDiseaseModal')">Cancel</button>
          <button type="submit" class="btn-primary">Add Disease</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Question Modal -->
  <div class="modal-overlay" id="addQuestionModal">
    <div class="modal" style="max-width: 600px;">
      <button class="modal-close" onclick="closeModal('addQuestionModal')">√ó</button>
      <h2 id="questionModalTitle" style="margin-bottom: 1.5rem;"></h2>
      <div id="questionEditModeIndicator" class="edit-mode-indicator" style="display: none;">You are editing a question</div>
      
      <form id="addQuestionForm">
        <div class="form-group">
          <label class="form-label">Question Text</label>
          <input type="text" class="form-input" id="questionText" placeholder="Enter your question here" required>
        </div>

        <div class="form-group">
          <label class="form-label">Question Type</label>
          <select class="form-input" id="questionType" required onchange="toggleQuestionOptions()">
            <option value="">Select question type</option>
            <option value="multiple-choice">Multiple Choice (Single Selection)</option>
            <option value="multiple-select">Multiple Choice (Multiple Selection)</option>
            <option value="yes-no">Yes/No</option>
            <option value="text">Text Input</option>
            <option value="textarea">Text Area (Long Answer)</option>
            <option value="number">Number Input</option>
            <option value="date">Date Input</option>
            <option value="rating">Rating Scale (1-10)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Question Description (Optional)</label>
          <textarea class="form-input" id="questionDescription" rows="2" placeholder="Add helpful information or instructions for this question"></textarea>
        </div>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="questionRequired" checked style="width: auto; margin: 0;">
            <span>This question is required</span>
          </label>
        </div>

        <div id="optionsSection" style="display: none;">
          <div class="form-group">
            <label class="form-label">Options (One per line)</label>
            <textarea class="form-input" id="questionOptions" rows="5" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
            <small style="color: var(--text-light);">Enter each option on a new line</small>
          </div>
        </div>

        <div class="form-group" id="validationSection" style="display: none;">
          <label class="form-label">Validation Options</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="font-size: 0.85rem; color: var(--text-light);">Minimum Value/Length</label>
              <input type="number" class="form-input" id="validationMin" placeholder="e.g., 0">
            </div>
            <div>
              <label style="font-size: 0.85rem; color: var(--text-light);">Maximum Value/Length</label>
              <input type="number" class="form-input" id="validationMax" placeholder="e.g., 100">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Question Order/Priority</label>
          <input type="number" class="form-input" id="questionOrder" placeholder="1" min="1" value="1">
          <small style="color: var(--text-light);">Lower numbers appear first (1 = first question)</small>
        </div>

        <div class="form-group">
          <label class="form-label">Question Dependencies (Optional)</label>
          <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.5rem;">This question will only appear if the dependencies are met</p>
          
          <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; display: block;">Dependency Logic:</label>
            <select class="form-input" id="dependencyLogic" style="max-width: 300px;">
              <option value="AND">Match ALL dependencies (AND)</option>
              <option value="OR">Match ANY dependency (OR)</option>
            </select>
            <small style="color: var(--text-light); display: block; margin-top: 0.25rem;">
              ‚Ä¢ AND: Question shows only when ALL dependencies are met<br>
              ‚Ä¢ OR: Question shows when ANY dependency is met
            </small>
          </div>
          
          <div id="dependenciesContainer">
            <!-- Dependencies will be added here -->
          </div>
          <button type="button" class="btn-secondary" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="addDependency()">+ Add Dependency</button>
        </div>

        <div class="form-group">
          <label class="form-label">Blocking Conditions (Optional)</label>
          <div id="blockingConditions">
            <!-- Will be populated dynamically -->
          </div>
          <button type="button" class="btn-secondary" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="addBlockingCondition()">+ Add Blocking Condition</button>
          <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">If user selects these answers, they cannot proceed to product selection</small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeModal('addQuestionModal')">Cancel</button>
          <button type="submit" class="btn-primary">Add Question</button>
        </div>
      </form>
    </div>
  </div>

  <div id="footer"></div>

  <script src="../js/app.js"></script>
  <script>
    // Initialize diseases data (global scope)
    var diseases = JSON.parse(localStorage.getItem('diseases') || '[]');
    var currentDisease = null;
    var editingQuestionId = null;
    
    // Functions will be defined directly on window object below
    console.log('üìã Script starting...');

    // Save diseases to localStorage
    function saveDiseases() {
      localStorage.setItem('diseases', JSON.stringify(diseases));
    }

    // Default diseases if none exist
    if (diseases.length === 0) {
      diseases = [
        {
          id: 'erectile-dysfunction',
          name: 'Erectile Dysfunction',
          description: 'Assessment questions for erectile dysfunction treatment',
          questions: [
            {
              id: 'q1',
              text: 'How long have you been experiencing symptoms?',
              type: 'multiple-choice',
              options: ['Less than 1 month', '1-3 months', '3-6 months', 'More than 6 months']
            },
            {
              id: 'q2',
              text: 'Do you have any existing medical conditions?',
              type: 'multiple-select',
              options: ['Diabetes', 'Heart Disease', 'Hypertension', 'None']
            },
            {
              id: 'q3',
              text: 'Are you currently taking any medications?',
              type: 'textarea',
              options: []
            }
          ]
        }
      ];
      saveDiseases();
    }

    // Load and display diseases
    function loadDiseases() {
      const diseasesList = document.getElementById('diseasesList');
      if (!diseasesList) return; // Element doesn't exist yet
      diseasesList.innerHTML = '';

      diseases.forEach(disease => {
        const diseaseCard = document.createElement('div');
        diseaseCard.className = 'service-card';
        diseaseCard.style.cursor = 'pointer';
        diseaseCard.onclick = () => selectDisease(disease.id);
        
        diseaseCard.innerHTML = `
          <h3>${disease.name}</h3>
          <p style="font-size: 0.9rem; color: var(--text-light);">${disease.questions.length} question(s)</p>
          <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
            <button class="btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="event.stopPropagation(); deleteDisease('${disease.id}')">Delete</button>
          </div>
        `;
        
        diseasesList.appendChild(diseaseCard);
      });
    }

    // Select disease to view/edit questions - defined directly on window
    window.selectDisease = function(diseaseId) {
      console.log('üîµ selectDisease() called with ID:', diseaseId);
      currentDisease = diseases.find(d => d.id === diseaseId);
      if (!currentDisease) {
        console.log('‚ùå Disease not found:', diseaseId);
        return;
      }
      console.log('‚úÖ Disease selected:', currentDisease.name);

      const titleEl = document.getElementById('selectedDiseaseTitle');
      const nameEl = document.getElementById('selectedDiseaseName');
      const sectionEl = document.getElementById('questionsSection');
      
      if (titleEl) titleEl.textContent = `${currentDisease.name} Questions`;
      if (nameEl) nameEl.textContent = currentDisease.name;
      if (sectionEl) sectionEl.style.display = 'block';
      
      loadQuestions();
      console.log('‚úÖ Questions loaded for disease');
    };
    console.log('‚úÖ selectDisease defined on window');

    // Load questions for selected disease
    function loadQuestions() {
      if (!currentDisease) return;

      const questionsList = document.getElementById('questionsList');
      questionsList.innerHTML = '';

      if (currentDisease.questions.length === 0) {
        questionsList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No questions yet. Click "Add Question" to get started.</p>';
        return;
      }

      currentDisease.questions.forEach((question, index) => {
        const questionCard = document.createElement('div');
        questionCard.style.cssText = 'padding: 1rem; background-color: var(--bg-light); border-radius: 4px; margin-bottom: 1rem;';
        
        let optionsText = '';
        if (question.options && question.options.length > 0) {
          optionsText = `<div style="margin-top: 0.5rem; color: var(--text-light);">
            Type: ${getQuestionTypeLabel(question.type)}<br>
            Options: ${question.options.join(', ')}
          </div>`;
        } else {
          optionsText = `<div style="margin-top: 0.5rem; color: var(--text-light);">
            Type: ${getQuestionTypeLabel(question.type)}
          </div>`;
        }

        let dependencyText = '';
        if (question.dependencies && question.dependencies.length > 0) {
          const depTexts = question.dependencies.map(dep => {
            const depQuestion = currentDisease.questions.find(q => q.id === dep.questionId);
            if (depQuestion) {
              return `"${depQuestion.text}" = "${dep.answer}"`;
            }
            return '';
          }).filter(Boolean);
          
          const logic = question.dependencyLogic || 'AND';
          
          if (depTexts.length > 0) {
            dependencyText = `<div style="margin-top: 0.5rem; color: var(--primary-teal); font-size: 0.85rem;">
              ‚ö° Depends on (${logic}): ${depTexts.join(` <strong>${logic}</strong> `)}
            </div>`;
          }
        }
        
        let descriptionText = '';
        if (question.description) {
          descriptionText = `<div style="margin-top: 0.5rem; color: var(--text-light); font-style: italic; font-size: 0.9rem;">
            "${question.description}"
          </div>`;
        }
        
        let validationText = '';
        if (question.validation && Object.keys(question.validation).length > 0) {
          const parts = [];
          if (question.validation.min !== undefined) parts.push(`Min: ${question.validation.min}`);
          if (question.validation.max !== undefined) parts.push(`Max: ${question.validation.max}`);
          if (parts.length > 0) {
            validationText = `<div style="margin-top: 0.5rem; color: var(--text-light); font-size: 0.85rem;">
              üìè Validation: ${parts.join(', ')}
            </div>`;
          }
        }
        
        const requiredBadge = question.required === false ? '<span style="color: var(--text-light); font-size: 0.85rem;">(Optional)</span>' : '<span style="color: var(--primary-teal); font-size: 0.85rem;">(Required)</span>';

        let blockingText = '';
        if (question.blockingConditions && question.blockingConditions.length > 0) {
          blockingText = `<div style="margin-top: 0.5rem; color: var(--error); font-size: 0.85rem;">
            üö´ Blocks progression if: ${question.blockingConditions.map(bc => {
              const q = currentDisease.questions.find(q => q.id === bc.questionId);
              return q ? `"${q.text}" = "${bc.answer}"` : '';
            }).filter(Boolean).join(', ')}
          </div>`;
        }

        questionCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <strong>${index + 1}. ${question.text}</strong> ${requiredBadge}
              ${descriptionText}
              ${optionsText}
              ${validationText}
              ${dependencyText}
              ${blockingText}
              <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-light);">
                Order: ${question.order || 999}
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn-edit" style="padding: 0.5rem 1rem;" onclick="editQuestion('${question.id}')">Edit</button>
              <button class="btn-secondary" style="padding: 0.5rem 1rem; color: var(--error); border-color: var(--error);" onclick="deleteQuestion('${question.id}')">Delete</button>
            </div>
          </div>
        `;
        
        questionsList.appendChild(questionCard);
      });
    }

    // Get question type label
    function getQuestionTypeLabel(type) {
      const labels = {
        'multiple-choice': 'Multiple Choice (Single)',
        'multiple-select': 'Multiple Choice (Multiple)',
        'text': 'Text Input',
        'textarea': 'Text Area',
        'yes-no': 'Yes/No',
        'number': 'Number Input',
        'date': 'Date Input',
        'rating': 'Rating Scale (1-10)'
      };
      return labels[type] || type;
    }

    // Show add disease modal - defined directly on window
    window.showAddDiseaseModal = function() {
      console.log('üîµ showAddDiseaseModal() called');
      try {
        const form = document.getElementById('addDiseaseForm');
        if (form) {
          form.reset();
        }
        const modal = document.getElementById('addDiseaseModal');
        if (modal) {
          console.log('‚úÖ Modal found, showing...');
          modal.classList.add('active');
          document.body.style.overflow = 'hidden';
        } else {
          console.error('‚ùå Modal addDiseaseModal not found');
          alert('Error: Modal not found. Please refresh the page.');
        }
      } catch (error) {
        console.error('‚ùå Error showing modal:', error);
        alert('Error opening modal: ' + error.message);
      }
    };
    console.log('‚úÖ showAddDiseaseModal defined on window');

    // Show add question modal - defined directly on window
    window.showAddQuestionModal = function() {
      console.log('üîµ showAddQuestionModal() called');
      if (!currentDisease) {
        console.log('‚ö†Ô∏è No disease selected');
        alert('Please select a disease first');
        return;
      }
      console.log('‚úÖ Disease selected:', currentDisease.name);
      try {
        editingQuestionId = null;
        const titleEl = document.getElementById('questionModalTitle');
        if (titleEl) titleEl.textContent = 'Add New Question';
        const indicatorEl = document.getElementById('questionEditModeIndicator');
        if (indicatorEl) indicatorEl.style.display = 'none';
        const form = document.getElementById('addQuestionForm');
        if (form) form.reset();
        const optionsSection = document.getElementById('optionsSection');
        if (optionsSection) optionsSection.style.display = 'none';
        const validationSection = document.getElementById('validationSection');
        if (validationSection) validationSection.style.display = 'none';
        const depsContainer = document.getElementById('dependenciesContainer');
        if (depsContainer) depsContainer.innerHTML = '';
        const blockingContainer = document.getElementById('blockingConditions');
        if (blockingContainer) blockingContainer.innerHTML = '';
        const orderInput = document.getElementById('questionOrder');
        if (orderInput) orderInput.value = (currentDisease.questions.length + 1).toString();
        const dependencyLogic = document.getElementById('dependencyLogic');
        if (dependencyLogic) dependencyLogic.value = 'AND';
        const questionRequired = document.getElementById('questionRequired');
        if (questionRequired) questionRequired.checked = true;
        
        if (typeof showModal === 'function') {
          console.log('‚úÖ Using showModal function');
          showModal('addQuestionModal');
        } else {
          console.log('‚ö†Ô∏è showModal not available, using direct manipulation');
          const modal = document.getElementById('addQuestionModal');
          if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('‚úÖ Modal shown directly');
          } else {
            console.error('‚ùå Modal addQuestionModal not found');
          }
        }
      } catch (error) {
        console.error('‚ùå Error showing question modal:', error);
        alert('Error opening modal: ' + error.message);
      }
    };
    console.log('‚úÖ showAddQuestionModal defined on window');

    // Toggle question options based on type
    function toggleQuestionOptions() {
      const questionType = document.getElementById('questionType').value;
      const optionsSection = document.getElementById('optionsSection');
      const validationSection = document.getElementById('validationSection');
      
      // Show options for choice-based questions
      if (questionType === 'multiple-choice' || questionType === 'multiple-select') {
        optionsSection.style.display = 'block';
        validationSection.style.display = 'none';
        document.getElementById('questionOptions').value = '';
      } else if (questionType === 'yes-no') {
        optionsSection.style.display = 'block';
        validationSection.style.display = 'none';
        document.getElementById('questionOptions').value = 'Yes\nNo';
      } else if (questionType === 'rating') {
        optionsSection.style.display = 'none';
        validationSection.style.display = 'none';
        // Rating scale is always 1-10
        document.getElementById('questionOptions').value = '';
      } else if (questionType === 'number' || questionType === 'text' || questionType === 'textarea') {
        optionsSection.style.display = 'none';
        validationSection.style.display = 'block';
      } else {
        optionsSection.style.display = 'none';
        validationSection.style.display = 'none';
      }
    }

    // Add dependency - defined directly on window
    window.addDependency = function() {
      console.log('üîµ addDependency() called');
      if (!currentDisease || currentDisease.questions.length === 0) {
        console.log('‚ö†Ô∏è No disease or questions available');
        alert('Please add questions first before setting dependencies');
        return;
      }
      console.log('‚úÖ Adding dependency, current questions:', currentDisease.questions.length);

      const dependenciesContainer = document.getElementById('dependenciesContainer');
      if (!dependenciesContainer) {
        console.error('dependenciesContainer not found');
        return;
      }
      
      const dependencyDiv = document.createElement('div');
      dependencyDiv.className = 'dependency-item';
      dependencyDiv.style.cssText = 'display: flex; gap: 0.5rem; align-items: flex-start; margin-bottom: 0.5rem; padding: 0.75rem; background: var(--bg-light); border-radius: 4px;';
      
      const questionSelect = document.createElement('select');
      questionSelect.className = 'form-input';
      questionSelect.style.flex = '1';
      questionSelect.innerHTML = '<option value="">Select question</option>';
      currentDisease.questions.forEach(q => {
        if (q.id !== editingQuestionId) {
          questionSelect.innerHTML += `<option value="${q.id}">${q.text}</option>`;
        }
      });
      
      const answerSelect = document.createElement('select');
      answerSelect.className = 'form-input';
      answerSelect.style.flex = '1';
      answerSelect.innerHTML = '<option value="">Select answer</option>';
      answerSelect.name = 'dependencyAnswer';
      
      questionSelect.addEventListener('change', function() {
        const selectedQ = currentDisease.questions.find(q => q.id === this.value);
        answerSelect.innerHTML = '<option value="">Select answer</option>';
        if (selectedQ && selectedQ.options) {
          selectedQ.options.forEach(opt => {
            answerSelect.innerHTML += `<option value="${opt}">${opt}</option>`;
          });
        } else if (selectedQ && (selectedQ.type === 'text' || selectedQ.type === 'textarea')) {
          answerSelect.innerHTML = '<option value="*">Any answer</option>';
        }
      });
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn-secondary';
      removeBtn.textContent = 'Remove';
      removeBtn.style.padding = '0.5rem 1rem';
      removeBtn.onclick = () => dependencyDiv.remove();
      
      dependencyDiv.appendChild(questionSelect);
      dependencyDiv.appendChild(answerSelect);
      dependencyDiv.appendChild(removeBtn);
      dependenciesContainer.appendChild(dependencyDiv);
      console.log('‚úÖ Dependency added successfully');
    };
    console.log('‚úÖ addDependency defined on window');

    // Load dependencies for editing
    function loadDependencies(question) {
      const dependenciesContainer = document.getElementById('dependenciesContainer');
      dependenciesContainer.innerHTML = '';
      
      if (question && question.dependencies && question.dependencies.length > 0) {
        question.dependencies.forEach(dep => {
          const dependencyDiv = document.createElement('div');
          dependencyDiv.className = 'dependency-item';
          dependencyDiv.style.cssText = 'display: flex; gap: 0.5rem; align-items: flex-start; margin-bottom: 0.5rem; padding: 0.75rem; background: var(--bg-light); border-radius: 4px;';
          
          const questionSelect = document.createElement('select');
          questionSelect.className = 'form-input';
          questionSelect.style.flex = '1';
          questionSelect.innerHTML = '<option value="">Select question</option>';
          currentDisease.questions.forEach(q => {
            if (q.id !== editingQuestionId) {
              questionSelect.innerHTML += `<option value="${q.id}" ${q.id === dep.questionId ? 'selected' : ''}>${q.text}</option>`;
            }
          });
          
          const answerSelect = document.createElement('select');
          answerSelect.className = 'form-input';
          answerSelect.style.flex = '1';
          answerSelect.name = 'dependencyAnswer';
          
          questionSelect.addEventListener('change', function() {
            const selectedQ = currentDisease.questions.find(q => q.id === this.value);
            answerSelect.innerHTML = '<option value="">Select answer</option>';
            if (selectedQ && selectedQ.options) {
              selectedQ.options.forEach(opt => {
                answerSelect.innerHTML += `<option value="${opt}" ${opt === dep.answer ? 'selected' : ''}>${opt}</option>`;
              });
            } else if (selectedQ && (selectedQ.type === 'text' || selectedQ.type === 'textarea')) {
              answerSelect.innerHTML = `<option value="*" ${dep.answer === '*' ? 'selected' : ''}>Any answer</option>`;
            }
          });
          
          // Trigger change to populate answers
          questionSelect.dispatchEvent(new Event('change'));
          
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'btn-secondary';
          removeBtn.textContent = 'Remove';
          removeBtn.style.padding = '0.5rem 1rem';
          removeBtn.onclick = () => dependencyDiv.remove();
          
          dependencyDiv.appendChild(questionSelect);
          dependencyDiv.appendChild(answerSelect);
          dependencyDiv.appendChild(removeBtn);
          dependenciesContainer.appendChild(dependencyDiv);
        });
      }
    }

    // Add blocking condition - defined directly on window
    window.addBlockingCondition = function() {
      console.log('üîµ addBlockingCondition() called');
      if (!currentDisease || currentDisease.questions.length === 0) {
        console.log('‚ö†Ô∏è No disease or questions available');
        alert('Please add questions first before setting blocking conditions');
        return;
      }
      console.log('‚úÖ Adding blocking condition');

      const blockingConditions = document.getElementById('blockingConditions');
      if (!blockingConditions) {
        console.error('blockingConditions container not found');
        return;
      }
      
      const conditionDiv = document.createElement('div');
      conditionDiv.style.cssText = 'display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-light); border-radius: 4px;';
      
      const questionSelect = document.createElement('select');
      questionSelect.className = 'form-input';
      questionSelect.style.flex = '1';
      questionSelect.innerHTML = '<option value="">Select question</option>';
      currentDisease.questions.forEach(q => {
        questionSelect.innerHTML += `<option value="${q.id}">${q.text}</option>`;
      });
      
      const answerSelect = document.createElement('select');
      answerSelect.className = 'form-input';
      answerSelect.style.flex = '1';
      answerSelect.innerHTML = '<option value="">Select answer</option>';
      answerSelect.name = 'blockingAnswer';
      
      questionSelect.addEventListener('change', function() {
        const selectedQ = currentDisease.questions.find(q => q.id === this.value);
        answerSelect.innerHTML = '<option value="">Select answer</option>';
        if (selectedQ && selectedQ.options) {
          selectedQ.options.forEach(opt => {
            answerSelect.innerHTML += `<option value="${opt}">${opt}</option>`;
          });
        }
      });
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn-secondary';
      removeBtn.textContent = 'Remove';
      removeBtn.style.padding = '0.5rem 1rem';
      removeBtn.onclick = () => conditionDiv.remove();
      
      conditionDiv.appendChild(questionSelect);
      conditionDiv.appendChild(answerSelect);
      conditionDiv.appendChild(removeBtn);
      blockingConditions.appendChild(conditionDiv);
      console.log('‚úÖ Blocking condition added successfully');
    };
    console.log('‚úÖ addBlockingCondition defined on window');

    // Initialize event listeners function
    function initEventListeners() {
      // Handle add disease form
      const addDiseaseForm = document.getElementById('addDiseaseForm');
      if (addDiseaseForm) {
        addDiseaseForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const name = document.getElementById('diseaseName').value.trim();
          const description = document.getElementById('diseaseDescription').value.trim();
          const id = name.toLowerCase().replace(/\s+/g, '-');

          if (diseases.find(d => d.id === id)) {
            alert('This disease already exists!');
            return;
          }

          diseases.push({
            id: id,
            name: name,
            description: description,
            questions: []
          });

          saveDiseases();
          loadDiseases();
          closeModal('addDiseaseModal');
          alert(`"${name}" has been added successfully!`);
        });
      }

      // Handle add question form
      const addQuestionForm = document.getElementById('addQuestionForm');
      if (addQuestionForm) {
        addQuestionForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          if (!currentDisease) return;

          const text = document.getElementById('questionText').value.trim();
          const type = document.getElementById('questionType').value;
          const description = document.getElementById('questionDescription').value.trim();
          const required = document.getElementById('questionRequired').checked;
          const order = parseInt(document.getElementById('questionOrder').value) || 999;
          let options = [];
          let validation = {};

          if (type === 'multiple-choice' || type === 'multiple-select' || type === 'yes-no') {
            const optionsText = document.getElementById('questionOptions').value.trim();
            options = optionsText.split('\n').map(o => o.trim()).filter(o => o.length > 0);
            
            if (options.length === 0) {
              alert('Please provide at least one option');
              return;
            }
          }

          // Get validation options for text/number fields
          if (type === 'number' || type === 'text' || type === 'textarea') {
            const min = document.getElementById('validationMin').value;
            const max = document.getElementById('validationMax').value;
            if (min) validation.min = parseFloat(min);
            if (max) validation.max = parseFloat(max);
          }

          // Get dependencies (multiple)
          const dependencies = [];
          const dependencyLogic = document.getElementById('dependencyLogic').value || 'AND';
          const dependencyDivs = document.querySelectorAll('#dependenciesContainer > div');
          dependencyDivs.forEach(div => {
            const questionSelect = div.querySelector('select:first-child');
            const answerSelect = div.querySelector('select[name="dependencyAnswer"]');
            if (questionSelect && answerSelect && questionSelect.value && answerSelect.value) {
              dependencies.push({
                questionId: questionSelect.value,
                answer: answerSelect.value
              });
            }
          });

          // Get blocking conditions
          const blockingConditions = [];
          const blockingDivs = document.querySelectorAll('#blockingConditions > div');
          blockingDivs.forEach(div => {
            const questionSelect = div.querySelector('select:first-child');
            const answerSelect = div.querySelector('select[name="blockingAnswer"]');
            if (questionSelect && answerSelect && questionSelect.value && answerSelect.value) {
              blockingConditions.push({
                questionId: questionSelect.value,
                answer: answerSelect.value
              });
            }
          });

          const question = {
            id: editingQuestionId || 'q' + Date.now(),
            text: text,
            type: type,
            description: description || null,
            required: required,
            options: options,
            validation: Object.keys(validation).length > 0 ? validation : null,
            order: order,
            dependencies: dependencies.length > 0 ? dependencies : null,
            dependencyLogic: dependencies.length > 1 ? dependencyLogic : 'AND',
            blockingConditions: blockingConditions
          };

          if (editingQuestionId) {
            // Update existing question
            const questionIndex = currentDisease.questions.findIndex(q => q.id === editingQuestionId);
            if (questionIndex !== -1) {
              currentDisease.questions[questionIndex] = question;
            }
          } else {
            // Add new question
            currentDisease.questions.push(question);
          }

          // Sort questions by order
          currentDisease.questions.sort((a, b) => (a.order || 999) - (b.order || 999));

          saveDiseases();
          loadQuestions();
          closeModal('addQuestionModal');
          editingQuestionId = null;
        });
      }
    }

    // Delete disease - defined directly on window
    window.deleteDisease = function(diseaseId) {
      console.log('üîµ deleteDisease() called with ID:', diseaseId);
      if (!confirm('Are you sure you want to delete this disease and all its questions?')) {
        console.log('‚ö†Ô∏è Delete cancelled by user');
        return;
      }
      console.log('‚úÖ Deleting disease:', diseaseId);

      diseases = diseases.filter(d => d.id !== diseaseId);
      saveDiseases();
      loadDiseases();
      
      if (currentDisease && currentDisease.id === diseaseId) {
        const sectionEl = document.getElementById('questionsSection');
        if (sectionEl) sectionEl.style.display = 'none';
        currentDisease = null;
      }
      console.log('‚úÖ Disease deleted successfully');
    };
    console.log('‚úÖ deleteDisease defined on window');

    // Delete question - defined directly on window
    window.deleteQuestion = function(questionId) {
      console.log('üîµ deleteQuestion() called with ID:', questionId);
      if (!confirm('Are you sure you want to delete this question?')) {
        console.log('‚ö†Ô∏è Delete cancelled by user');
        return;
      }
      console.log('‚úÖ Deleting question:', questionId);

      if (!currentDisease) return;
      currentDisease.questions = currentDisease.questions.filter(q => q.id !== questionId);
      saveDiseases();
      loadQuestions();
      console.log('‚úÖ Question deleted successfully');
    };
    console.log('‚úÖ deleteQuestion defined on window');

    // Edit question - defined directly on window
    window.editQuestion = function(questionId) {
      console.log('üîµ editQuestion() called with ID:', questionId);
      const question = currentDisease.questions.find(q => q.id === questionId);
      if (!question) {
        console.log('‚ùå Question not found:', questionId);
        return;
      }
      console.log('‚úÖ Editing question:', question.text);

      editingQuestionId = questionId;
      document.getElementById('questionModalTitle').textContent = 'Edit Question';
      document.getElementById('questionEditModeIndicator').style.display = 'flex';
      
      document.getElementById('questionText').value = question.text;
      document.getElementById('questionType').value = question.type;
      document.getElementById('questionDescription').value = question.description || '';
      document.getElementById('questionRequired').checked = question.required !== false;
      document.getElementById('questionOrder').value = question.order || 999;
      document.getElementById('dependencyLogic').value = question.dependencyLogic || 'AND';
      
      toggleQuestionOptions();
      
      if (question.options && question.options.length > 0) {
        document.getElementById('questionOptions').value = question.options.join('\n');
      }
      
      // Load validation options
      if (question.validation) {
        document.getElementById('validationMin').value = question.validation.min || '';
        document.getElementById('validationMax').value = question.validation.max || '';
      }

      // Load dependencies
      loadDependencies(question);

      // Load blocking conditions
      document.getElementById('blockingConditions').innerHTML = '';
      if (question.blockingConditions && question.blockingConditions.length > 0) {
        question.blockingConditions.forEach(condition => {
          const conditionDiv = document.createElement('div');
          conditionDiv.style.cssText = 'display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-light); border-radius: 4px;';
          
          const questionSelect = document.createElement('select');
          questionSelect.className = 'form-input';
          questionSelect.style.flex = '1';
          questionSelect.innerHTML = '<option value="">Select question</option>';
          currentDisease.questions.forEach(q => {
            questionSelect.innerHTML += `<option value="${q.id}" ${q.id === condition.questionId ? 'selected' : ''}>${q.text}</option>`;
          });
          
          const answerSelect = document.createElement('select');
          answerSelect.className = 'form-input';
          answerSelect.style.flex = '1';
          answerSelect.name = 'blockingAnswer';
          
          questionSelect.addEventListener('change', function() {
            const selectedQ = currentDisease.questions.find(q => q.id === this.value);
            answerSelect.innerHTML = '<option value="">Select answer</option>';
            if (selectedQ && selectedQ.options) {
              selectedQ.options.forEach(opt => {
                answerSelect.innerHTML += `<option value="${opt}" ${opt === condition.answer ? 'selected' : ''}>${opt}</option>`;
              });
            }
          });
          
          // Trigger change to populate answers
          questionSelect.dispatchEvent(new Event('change'));
          
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'btn-secondary';
          removeBtn.textContent = 'Remove';
          removeBtn.style.padding = '0.5rem 1rem';
          removeBtn.onclick = () => conditionDiv.remove();
          
          conditionDiv.appendChild(questionSelect);
          conditionDiv.appendChild(answerSelect);
          conditionDiv.appendChild(removeBtn);
          document.getElementById('blockingConditions').appendChild(conditionDiv);
        });
      }

      if (typeof showModal === 'function') {
        showModal('addQuestionModal');
      } else {
        const modal = document.getElementById('addQuestionModal');
        if (modal) {
          modal.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }
      console.log('‚úÖ Question edit modal shown');
    };
    console.log('‚úÖ editQuestion defined on window');

    // Initialize - wait for DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        initEventListeners();
        loadDiseases();
        if (typeof setupModalClose === 'function') {
          setupModalClose('addDiseaseModal');
          setupModalClose('addQuestionModal');
        }
      });
    } else {
      initEventListeners();
      loadDiseases();
      if (typeof setupModalClose === 'function') {
        setupModalClose('addDiseaseModal');
        setupModalClose('addQuestionModal');
      }
    }
  </script>
</body>
</html>
